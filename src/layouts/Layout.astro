---
import Orb from "../components/Orb.jsx";
import CookieBanner from "../components/CookieBanner.astro";

interface Props {
    title: string;
}
const { title } = Astro.props;

const GA_ID = "G-4FLC2T40F9";
---

<!doctype html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="theme-color" content="#050505" />
        <meta
            name="description"
            content="Byit: Desarrollo web de alto rendimiento."
        />
        <link rel="icon" type="image/png" href="/img/favicon.png" />
        <link rel="apple-touch-icon" href="/img/favicon.png" />
        <meta property="og:title" content={title} />
        <meta property="og:type" content="website" />
        <meta property="og:image" content="/img/og-image.png" />
        <title>{title}</title>

        <!-- DNS Preconnect para recursos externos -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link rel="preconnect" href="https://www.googletagmanager.com" />
        <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" />

        <!-- Fuentes con display=swap para evitar FOIT -->
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
            rel="stylesheet"
        />
        <link
            href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@1,900&display=swap"
            rel="stylesheet"
        />

        <!-- Google Tag Manager con Partytown (corre en Web Worker) -->
        <script type="text/partytown">
            (function (w, d, s, l, i) {
                w[l] = w[l] || [];
                w[l].push({
                    "gtm.start": new Date().getTime(),
                    event: "gtm.js",
                });
                var f = d.getElementsByTagName(s)[0],
                    j = d.createElement(s),
                    dl = l != "dataLayer" ? "&l=" + l : "";
                j.async = true;
                j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
                f.parentNode.insertBefore(j, f);
            })(window, document, "script", "dataLayer", "GTM-PNH455WH");
        </script>

        <!-- Google Analytics con Partytown -->
        <script type="text/partytown" define:vars={{ GA_ID }}>
            window.dataLayer = window.dataLayer || [];
            function gtag() {
                dataLayer.push(arguments);
            }
            gtag("consent", "default", {
                ad_storage: "denied",
                analytics_storage: "denied",
            });
            gtag("js", new Date());
            gtag("config", GA_ID);
        </script>
        <script
            type="text/partytown"
            async
            src={`https://www.googletagmanager.com/gtag/js?id=${GA_ID}`}
        ></script>
    </head>

    <body class="bg-transparent text-white font-sans antialiased relative">
        <noscript>
            <iframe
                src="https://www.googletagmanager.com/ns.html?id=GTM-PNH455WH"
                height="0"
                width="0"
                style="display:none;visibility:hidden"></iframe>
        </noscript>

        <div
            style="position: fixed; top: -100vh; left: 0; width: 100%; height: 300vh; z-index: -9999; background-color: #050505; pointer-events: none;"
        >
            <div
                class="absolute inset-0 bg-gradient-to-b from-primary/10 to-transparent"
            >
            </div>
        </div>

        <div
            id="orb-container"
            class="fixed top-0 left-0 w-full h-[800px] -z-10 transition-opacity duration-500 ease-out opacity-90"
        >
            <Orb
                client:load
                hue={0}
                hoverIntensity={0.6}
                rotateOnHover={true}
                backgroundColor="#000000"
            />
        </div>

        <slot />

        <CookieBanner />

        <script>
            // 1. Orb Opacity
            const orbContainer = document.getElementById("orb-container");
            window.addEventListener("scroll", () => {
                if (orbContainer)
                    orbContainer.style.opacity = Math.max(
                        0,
                        0.9 - window.scrollY / 600,
                    ).toString();
            });

            // 2. Scroll Suave con Lenis - Carga diferida después de FCP
            let lenis;

            // Cargar Lenis después de que la página esté lista (no bloquea renderizado inicial)
            async function initLenis() {
                // Importación dinámica para no bloquear el critical path
                const LenisModule =
                    await import("https://cdn.jsdelivr.net/npm/lenis@1.1.18/+esm");
                const Lenis = LenisModule.default;

                lenis = new Lenis({
                    duration: 1.2,
                    easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
                    direction: "vertical",
                    gestureDirection: "vertical",
                    smooth: true,
                    mouseMultiplier: 1,
                    smoothTouch: true,
                    touchMultiplier: 2,
                });

                function raf(time) {
                    lenis.raf(time);
                    requestAnimationFrame(raf);
                }
                requestAnimationFrame(raf);

                // Smooth scroll para anclas
                document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
                    anchor.addEventListener("click", function (e) {
                        e.preventDefault();
                        const href = this.getAttribute("href");
                        if (href && href !== "#") {
                            const target = document.querySelector(href);
                            if (target)
                                lenis.scrollTo(target, {
                                    offset: -20,
                                    duration: 1.5,
                                });
                        }
                    });
                });
            }

            // Iniciar después de que el DOM esté listo
            if (document.readyState === "loading") {
                document.addEventListener("DOMContentLoaded", initLenis);
            } else {
                // Ya está listo, iniciar inmediatamente
                initLenis();
            }

            // 3. Animaciones Scroll
            const observerOptions = {
                root: null,
                rootMargin: "0px",
                threshold: 0.1,
            };
            const observer = new IntersectionObserver((entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add("is-visible");
                        observer.unobserve(entry.target);
                    }
                });
            }, observerOptions);

            document
                .querySelectorAll(".animate-on-scroll, .title-glow")
                .forEach((el) => observer.observe(el));
        </script>
    </body>
</html>

<style is:global>
    /* === AJUSTES PARA LENIS EN MÓVIL === */

    html.lenis,
    html.lenis body {
        height: auto;
    }

    html {
        background-color: #050505;
        height: auto;
        min-height: 100%;

        /* IMPORTANTE: Si Lenis controla el touch, quitamos touch-action restrictivo */
        /* touch-action: pan-y;  <-- LO QUITAMOS para que Lenis decida */

        overscroll-behavior: auto; /* Dejar rebote visual */

        /* Aseguramos que no haya scroll nativo compitiendo si Lenis está activo */
        /* Pero necesitamos overflow para que funcione */
    }

    body {
        background-color: #050505;
        min-height: 100vh;
        width: 100%;
        overflow-x: hidden;
    }

    /* Clase que Lenis añade cuando está activo */
    .lenis.lenis-smooth {
        scroll-behavior: auto !important;
    }

    /* === ESTILOS GENERALES === */

    .font-fact {
        font-family: "Kanit", sans-serif;
        font-style: italic;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 0.02em;
    }

    ::-webkit-scrollbar {
        display: none;
    }
    html {
        scrollbar-width: none;
    }

    .animate-on-scroll {
        opacity: 0;
        transition:
            opacity 0.8s ease-out,
            transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
        will-change: opacity, transform;
    }
    .animate-on-scroll.fade-up {
        transform: translateY(40px);
    }
    .animate-on-scroll.from-left {
        transform: translateX(-40px);
    }
    .animate-on-scroll.from-right {
        transform: translateX(40px);
    }
    .animate-on-scroll.is-visible {
        opacity: 1;
        transform: translate(0, 0);
    }

    .title-glow {
        text-shadow: 0 0 10px rgba(255, 255, 255, 0);
        transition: text-shadow 1s ease;
    }
    .title-glow.is-visible {
        text-shadow:
            0 0 15px rgba(255, 255, 255, 0.45),
            0 0 30px rgba(255, 255, 255, 0.25);
    }
</style>
